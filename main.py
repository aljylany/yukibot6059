"""
Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ù†Ù‚Ø·Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
Main Bot Entry Point with Professional Structure
"""

import asyncio
import logging
import sys
import os
from datetime import datetime
from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

from config.settings import BOT_TOKEN
from config.database import init_database
from handlers import commands, callbacks, messages, smart_commands, bug_report_handler
from utils.helpers import setup_logging

# Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØªØ¨Ø¹ ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
BOT_START_TIME = None


async def check_restart_status(bot):
    """ÙØ­Øµ Ø­Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯"""
    try:
        import json
        if os.path.exists('restart_info.json'):
            with open('restart_info.json', 'r', encoding='utf-8') as f:
                restart_info = json.load(f)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
            success_message = (
                "âœ… **ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
                f"ğŸ‘‘ Ø§Ù„Ø³ÙŠØ¯: {restart_info['username']}\n"
                f"ğŸ”„ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­\n"
                f"âš¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ\n\n"
                f"ğŸ“Š **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:**\n"
                f"â€¢ Ø§Ù„Ù…Ø¹Ø±Ù: `{restart_info['user_id']}`\n"
                f"â€¢ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø£Ù…Ø± Ù…Ø·Ù„Ù‚\n"
                f"â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n\n"
                f"ğŸ¯ **Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±**"
            )
            
            await bot.send_message(restart_info['chat_id'], success_message)
            
            # Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            os.remove('restart_info.json')
            logging.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ø³ÙŠØ¯: {restart_info['user_id']}")
            
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: {e}")


async def main():
    """Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    global BOT_START_TIME
    BOT_START_TIME = datetime.now()  # ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    setup_logging()
    
    # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    bot = Bot(token=BOT_TOKEN)
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ²Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    dp = Dispatcher()
    
    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    dp.include_router(commands.router)
    dp.include_router(callbacks.router)
    dp.include_router(smart_commands.router)
    dp.include_router(bug_report_handler.router)
    
    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø§Ø¨Ø© (Ø¨Ø£ÙˆÙ„ÙˆÙŠØ© Ø£Ù‚Ù„ Ù…Ù† callbacks Ø§Ù„Ø¹Ø§Ù…Ø©)
    from modules.guild_commands import guild_router
    dp.include_router(guild_router)
    
    
    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    dp.include_router(messages.router)
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø£ÙˆÙ„ÙˆÙŠØ© Ø£Ù‚Ù„ - Ù„Ù„ÙØ­Øµ ÙÙ‚Ø·)
    from handlers import unified_message_processor
    dp.include_router(unified_message_processor.router)
    
    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    from handlers import group_events
    dp.include_router(group_events.router)
    
    # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ ØªØªØ¨Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    from handlers import group_message_tracker
    dp.include_router(group_message_tracker.router)
    
    # ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    from handlers import memory_commands
    dp.include_router(memory_commands.router)
    
    
    # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await init_database()
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ÙƒÙŠ
    try:
        from modules.bug_report_system import bug_report_system
        await bug_report_system.init_database()
        logging.info("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ÙƒÙŠ")
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ÙƒÙŠ: {e}")
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    try:
        from modules.content_moderation import content_moderator
        await content_moderator.init_violations_database()
        logging.info("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª")
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: {e}")
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ†ÙŠÙ
    try:
        from modules.ranking_system import init_ranking_system
        await init_ranking_system()
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ†ÙŠÙ: {e}")
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©
    try:
        from modules.guild_commands import initialize_guild_system, load_existing_players
        await initialize_guild_system()
        await load_existing_players()
        logging.info("ğŸ° ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©: {e}")
    
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØªØ¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    from config.hierarchy import load_ranks_from_database
    await load_ranks_from_database()
    
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø®ØµØµØ©
    from modules.custom_commands import load_custom_commands
    await load_custom_commands()
    
    # ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
    from modules.media_download import load_download_settings
    await load_download_settings()
    
    
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Real Yuki AI)
    try:
        from modules.real_ai import setup_real_ai
        await setup_real_ai()
        logging.info("ğŸ§  ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… ÙŠÙˆÙƒÙŠ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ")
    except Exception as ai_error:
        logging.warning(f"âš ï¸ ØªØ­Ø°ÙŠØ± ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: {ai_error}")
    
    # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ø¹ NLTK
    try:
        from modules.shared_memory import shared_group_memory
        await shared_group_memory.init_shared_memory_db()
        logging.info("ğŸ§  ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù…ØªØ±Ø§Ø¨Ø·Ø©")
    except Exception as shared_error:
        logging.warning(f"âš ï¸ ØªØ­Ø°ÙŠØ± ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©: {shared_error}")
    
    # ÙØ­Øµ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    await check_restart_status(bot)
    
    try:
        logging.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ webhooks Ù†Ø´Ø·Ø©
        try:
            await bot.delete_webhook(drop_pending_updates=True)
            logging.info("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ webhooks ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©")
        except Exception as webhook_error:
            logging.warning(f"âš ï¸ ØªØ­Ø°ÙŠØ± ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù€ webhooks: {webhook_error}")
        
        # Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        await asyncio.sleep(2)
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
        try:
            from modules.notification_manager import NotificationManager
            notification_manager = NotificationManager(bot)
            await notification_manager.send_startup_notification("2.0")
        except Exception as startup_error:
            logging.warning(f"âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: {startup_error}")
        
        # Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª
        await dp.start_polling(bot)
        
    except KeyboardInterrupt:
        logging.info("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
        # Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø± Ø¹Ù† Ø§Ù„Ø®Ø·Ø£
        import traceback
        logging.error(f"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: {traceback.format_exc()}")
    finally:
        try:
            await bot.session.close()
            logging.info("âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
        except Exception as close_error:
            logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©: {close_error}")


if __name__ == "__main__":
    if sys.version_info < (3, 8):
        logging.error("âŒ ÙŠØªØ·Ù„Ø¨ Python 3.8 Ø£Ùˆ Ø£Ø­Ø¯Ø«")
        sys.exit(1)
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
