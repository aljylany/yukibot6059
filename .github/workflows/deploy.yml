name: ๐ค ุจูุช ูููู ุงููุณุชูุฑ
# ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ ูุฑูู ูููู - ุงูุชุดุบูู ุงููุณุชูุฑ ุนูู GitHub Actions

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: yuki-telegram-bot
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ๐ฅ ุณุญุจ ุงูููุฏ ุงูุฃุณุงุณู
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐ ุชุญููู Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: โ๏ธ ุชููุฆุฉ Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: ๐พ ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูุชุดุบูู ุงูุณุงุจู
        run: |
          echo "๐ฅ ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูุจูุช ูู ูุฑุน ุงูุชุฎุฒูู..."
          if git fetch origin yuki-bot-storage 2>/dev/null; then
            echo "โ ุชู ุงูุนุซูุฑ ุนูู ูุฑุน ุชุฎุฒูู ุงูุจูุช"
            git checkout origin/yuki-bot-storage -- . 2>/dev/null || echo "โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุณุงุจูุฉ"
            echo "โ ุชู ุงุณุชุจุฏุงู ุงููููุงุช ุงููุฏููุฉ ุจูุณุฎุฉ ุงูุชุฎุฒูู"
          else
            echo "โ๏ธ ูุง ููุฌุฏ ูุฑุน ุชุฎุฒููุ ุณูุจุฏุฃ ุงูุจูุช ุจุจูุงูุงุช ุฌุฏูุฏุฉ"
          fi
          echo "๐ ุงูุชุญูู ูู ูููุงุช ุงูุจูุช ุจุนุฏ ุงูุชุญููู:"
          ls -la *.db *.json *.log *.txt 2>/dev/null || true
          if ! ls *.db 1> /dev/null 2>&1; then
            echo "โ ุชุญุฐูุฑ: ูุง ุชูุฌุฏ ูููุงุช ููุงุนุฏ ุจูุงูุงุช!"
          else
            echo "โ ูููุงุช ููุงุนุฏ ุงูุจูุงูุงุช ููุฌูุฏุฉ"
          fi

      - name: ๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "โ ููู requirements.txt ุบูุฑ ููุฌูุฏ!"
            exit 1
          fi

      - name: ๐ต ุชุซุจูุช ูุชุทูุจุงุช ุงูููุฏูุง
        run: |          
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          sudo apt-get install -y libcairo2-dev libpango1.0-dev libgdk-pixbuf-2.0-dev

      - name: ๐ ุงูุชุญูู ูู ุงูููุงุชูุญ
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "๐ ุงูุชุญูู ูู ุงูููุงุชูุญ ุงููุทููุจุฉ:"
          if [ -n "$BOT_TOKEN" ]; then
            echo "  โ BOT_TOKEN: ูุชููุฑ"
          else
            echo "  โ BOT_TOKEN: ููููุฏ - ูุฌุจ ุฅุถุงูุชู ูู GitHub Secrets"
            exit 1
          fi
          if [ -n "$GOOGLE_API_KEY" ]; then
            echo "  โ GOOGLE_API_KEY: ูุชููุฑ"
          else
            echo "  โ๏ธ GOOGLE_API_KEY: ููููุฏ"
          fi
          echo "โ ุงูููุงุชูุญ ุงูุฃุณุงุณูุฉ ูุชููุฑุฉ"

      - name: ๐ค ุชุดุบูู ุจูุช ูููู
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          GEMINI_API_KEY_7: ${{ secrets.GEMINI_API_KEY_7 }}
          GEMINI_API_KEY_8: ${{ secrets.GEMINI_API_KEY_8 }}
          GEMINI_API_KEY_9: ${{ secrets.GEMINI_API_KEY_9 }}
          GEMINI_API_KEY_10: ${{ secrets.GEMINI_API_KEY_10 }}
          GEMINI_API_KEY_11: ${{ secrets.GEMINI_API_KEY_11 }}
          GEMINI_API_KEY_12: ${{ secrets.GEMINI_API_KEY_12 }}
          GEMINI_API_KEY_13: ${{ secrets.GEMINI_API_KEY_13 }}
          GEMINI_API_KEY_14: ${{ secrets.GEMINI_API_KEY_14 }}
          GEMINI_API_KEY_15: ${{ secrets.GEMINI_API_KEY_15 }}
          GEMINI_API_KEY_16: ${{ secrets.GEMINI_API_KEY_16 }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "๐ ุจุฏุก ุชุดุบูู ุจูุช ูููู..."
          echo "๐ค ุงุณู ุงูุจูุช: Yuki Telegram Bot"
          echo "๐ ุงูุฅุตุฏุงุฑ: 2.0 ุงููุญุณู"
          echo "โก ุญุงูุฉ ุงูุจูุช: ุฌุงุฑู ุงูุชุดุบูู ุงููุณุชูุฑ..."
          echo "๐ ููุช ุงูุจุฏุก: $(date)"
          echo ""
          python main.py

      - name: ๐พ ุญูุธ ุจูุงูุงุช ูุฐุง ุงูุชุดุบูู
        if: always()
        run: |
          echo "๐พ ุฌุงุฑู ุญูุธ ุจูุงูุงุช ุงูุจูุช..."
          git checkout main
          git checkout yuki-bot-storage 2>/dev/null || git checkout -b yuki-bot-storage
          
          # ุฅุถุงูุฉ ุงููููุงุช ุงููููุฉ ููู gitignore
          echo "# ูููุงุช ุงูุจูุช ุงููุณุชุซูุงุฉ ูู ุงูุญูุธ" > .gitignore
          echo "main.py" >> .gitignore
          echo "config/" >> .gitignore
          echo "handlers/" >> .gitignore
          echo "modules/" >> .gitignore
          echo "utils/" >> .gitignore
          echo "services/" >> .gitignore
          echo "requirements.txt" >> .gitignore
          echo ".github/" >> .gitignore
          echo "*.md" >> .gitignore
          echo "*.sh" >> .gitignore
          
          # ุญูุธ ูููุงุช ุงูุจูุงูุงุช ููุท
          git add *.db *.json *.log *.txt temp_media/ 2>/dev/null || true
          git add --all
          git commit -m "๐ค ุญูุธ ุชููุงุฆู ูุจูุงูุงุช ุงูุจูุช - $(date +'%Y-%m-%d %H:%M:%S')" || echo "โน๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุญูุธ"
          git push origin yuki-bot-storage --force || echo "โ ูุดู ุฑูุน ุงูุจูุงูุงุช"
          git checkout main

      - name: โ ุชุฃููุฏ ุงูุชูุงุก ุงูุนูููุงุช
        if: always()
        run: |
          echo ""
          echo "๐ ููุฎุต ุงูุชุดุบูู:"
          echo "โ ุงูุชูุช ุฌูุณุฉ ุชุดุบูู ุงูุจูุช ุจูุฌุงุญ"
          echo "๐พ ุงูุจูุงูุงุช ูุญููุธุฉ ูู ูุฑุน: yuki-bot-storage"
          echo "๐ ููุช ุงูุงูุชูุงุก: $(date)"
          echo "๐ ุงูุฌูุณุฉ ุงููุงุฏูุฉ: ุฎูุงู 6 ุณุงุนุงุช"
          echo "๐ ูุฏุฉ ุงูุชุดุบูู: 6 ุณุงุนุงุช (ุฃู ุญุชู ุงูุชูุงุก ุงูููุงู)"
          echo ""
          echo "๐ฏ ุญุงูุฉ ุงูุจูุช: ุฌุงูุฒ ููุฌูุณุฉ ุงููุงุฏูุฉ"
