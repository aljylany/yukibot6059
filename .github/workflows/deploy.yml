name: ğŸ¤– ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ÙŠÙˆÙƒÙŠ Ø§Ù„Ù…Ø³ØªÙ…Ø±

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª Ùˆ 50 Ø¯Ù‚ÙŠÙ‚Ø© (Ù„ØªØ¬Ù†Ø¨ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ù€ 6 Ø³Ø§Ø¹Ø§Øª)
    - cron: '50 */5 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØª
    
    steps:
    - name: ğŸ“¥ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      run: |
        python -m py_compile main.py
        python -c "print('âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¬ØªØ§Ø² Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ø­ÙˆÙŠ')"

  docker:
    needs: test
    runs-on: ubuntu-latest
    name: ğŸ³ Ø¨Ù†Ø§Ø¡ Docker Image
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ³ Ø¨Ù†Ø§Ø¡ Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: yuki-bot:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: [test, docker]
    runs-on: ubuntu-latest
    name: ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø³ØªÙ…Ø±
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    timeout-minutes: 350  # 5 Ø³Ø§Ø¹Ø§Øª Ùˆ 50 Ø¯Ù‚ÙŠÙ‚Ø©
    
    steps:
    - name: ğŸ“¥ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ“Š Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
      run: |
        echo "ğŸ•’ ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: $(date)"
        echo "ğŸ–¥ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: $(uname -a)"
        echo "ğŸ Ø¥ØµØ¯Ø§Ø± Python: $(python --version)"
        echo "ğŸ“¦ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: $(df -h /)"
        
    - name: ğŸ¤– ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ÙŠÙˆÙƒÙŠ
      env:
        BOT_TOKEN: ${{ secrets.7942168520:AAEj18WjZ8Ek6TEFdp5ZLjGIk5jSG5L8z0o }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
        GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
        GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
        GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
        GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
        GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
        GEMINI_API_KEY_7: ${{ secrets.GEMINI_API_KEY_7 }}
        GEMINI_API_KEY_8: ${{ secrets.GEMINI_API_KEY_8 }}
        GEMINI_API_KEY_9: ${{ secrets.GEMINI_API_KEY_9 }}
        GEMINI_API_KEY_10: ${{ secrets.GEMINI_API_KEY_10 }}
        GEMINI_API_KEY_11: ${{ secrets.GEMINI_API_KEY_11 }}
        GEMINI_API_KEY_12: ${{ secrets.GEMINI_API_KEY_12 }}
        GEMINI_API_KEY_13: ${{ secrets.GEMINI_API_KEY_13 }}
        GEMINI_API_KEY_14: ${{ secrets.GEMINI_API_KEY_14 }}
        GEMINI_API_KEY_15: ${{ secrets.GEMINI_API_KEY_15 }}
        GEMINI_API_KEY_16: ${{ secrets.GEMINI_API_KEY_16 }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ÙŠÙˆÙƒÙŠ..."
        echo "ğŸ¤– Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª: Yuki Bot"
        echo "ğŸ“‹ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 2.0"
        echo "âš¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„..."
        echo ""
        echo "ğŸ”‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­:"
        if [ -n "$BOT_TOKEN" ]; then
          echo "  âœ… BOT_TOKEN: Ù…ØªÙˆÙØ±"
        else
          echo "  âŒ BOT_TOKEN: Ù…ÙÙ‚ÙˆØ¯"
        fi
        if [ -n "$GOOGLE_API_KEY" ]; then
          echo "  âœ… GOOGLE_API_KEY: Ù…ØªÙˆÙØ±"
        else
          echo "  âŒ GOOGLE_API_KEY: Ù…ÙÙ‚ÙˆØ¯"
        fi
        echo ""
        echo "ğŸ¯ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù„Ù…Ø¯Ø© 5 Ø³Ø§Ø¹Ø§Øª Ùˆ 50 Ø¯Ù‚ÙŠÙ‚Ø©..."
        echo "ğŸ”„ Ø¨Ø¹Ø¯Ù‡Ø§ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©"
        echo ""
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ timeout
        timeout 350m python main.py || {
          echo "â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (5 Ø³Ø§Ø¹Ø§Øª 50 Ø¯Ù‚ÙŠÙ‚Ø©)"
          echo "ğŸ”„ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©"
        }
        
    - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
      if: always()
      run: |
        echo ""
        echo "ğŸ“‹ Ù…Ù„Ø®Øµ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:"
        echo "ğŸ•’ ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: $(date)"
        echo "â±ï¸ Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: 5 Ø³Ø§Ø¹Ø§Øª 50 Ø¯Ù‚ÙŠÙ‚Ø© (Ø£Ùˆ Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„)"
        echo "ğŸ”„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: Ø®Ù„Ø§Ù„ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø­Ø³Ø¨ cron)"
        echo "ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${{ job.status }}"
        echo ""
        echo "âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­"

  # ØªØ´ØºÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
  backup-deploy:
    needs: [test]
    runs-on: ubuntu-latest
    name: ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    timeout-minutes: 350
    strategy:
      matrix:
        session: [backup-1, backup-2]
      fail-fast: false
    
    steps:
    - name: ğŸ“¥ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: â³ Ø§Ù†ØªØ¸Ø§Ø± (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„)
      run: |
        if [ "${{ matrix.session }}" = "backup-1" ]; then
          sleep 300  # Ø§Ù†ØªØ¸Ø§Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
        else
          sleep 600  # Ø§Ù†ØªØ¸Ø§Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚
        fi
        
    - name: ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ - ${{ matrix.session }}
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
        GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
        GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
        GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
        GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
        GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
        GEMINI_API_KEY_7: ${{ secrets.GEMINI_API_KEY_7 }}
        GEMINI_API_KEY_8: ${{ secrets.GEMINI_API_KEY_8 }}
        GEMINI_API_KEY_9: ${{ secrets.GEMINI_API_KEY_9 }}
        GEMINI_API_KEY_10: ${{ secrets.GEMINI_API_KEY_10 }}
        GEMINI_API_KEY_11: ${{ secrets.GEMINI_API_KEY_11 }}
        GEMINI_API_KEY_12: ${{ secrets.GEMINI_API_KEY_12 }}
        GEMINI_API_KEY_13: ${{ secrets.GEMINI_API_KEY_13 }}
        GEMINI_API_KEY_14: ${{ secrets.GEMINI_API_KEY_14 }}
        GEMINI_API_KEY_15: ${{ secrets.GEMINI_API_KEY_15 }}
        GEMINI_API_KEY_16: ${{ secrets.GEMINI_API_KEY_16 }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ğŸ”„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${{ matrix.session }}"
        timeout 345m python main.py || echo "â° Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"
