name: 🤖 بوت يوكي المستمر - نهائي
# ملف جاهز بدون GitHub Secrets - المفاتيح مُدمجة مباشرة

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: yuki-telegram-bot
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 📥 سحب الكود الأساسي
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🐍 تحميل Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ⚙️ تهيئة Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: 💾 استرجاع بيانات التشغيل السابق
        run: |
          echo "📥 جاري تحميل بيانات البوت من فرع التخزين..."
          if git fetch origin yuki-bot-storage 2>/dev/null; then
            echo "✅ تم العثور على فرع تخزين البوت"
            git checkout origin/yuki-bot-storage -- . 2>/dev/null || echo "⚠️ لا توجد بيانات سابقة"
            echo "✅ تم استبدال الملفات القديمة بنسخة التخزين"
          else
            echo "⚠️ لا يوجد فرع تخزين، سيبدأ البوت ببيانات جديدة"
          fi
          echo "📂 التحقق من ملفات البوت بعد التحميل:"
          ls -la *.db *.json *.log *.txt 2>/dev/null || true

      - name: 📦 تثبيت المتطلبات الأساسية
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "❌ ملف requirements.txt غير موجود!"
            exit 1
          fi

      - name: 🎵 تثبيت متطلبات الميديا
        run: |          
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          sudo apt-get install -y libcairo2-dev libpango1.0-dev libgdk-pixbuf-2.0-dev

      - name: 🤖 تشغيل بوت يوكي مع المفاتيح المُدمجة
        env:
          BOT_TOKEN: "7942168520:AAEj18WjZ8Ek6TEFdp5ZLjGIk5jSG5L8z0o"
          GOOGLE_API_KEY: "AIzaSyAnAc6MtS47ze-9VWWQz85OHpPpj_IR0Nw"
          GEMINI_API_KEY: "AIzaSyAnAc6MtS47ze-9VWWQz85OHpPpj_IR0Nw"
          GEMINI_API_KEY_1: "AIzaSyAnAc6MtS47ze-9VWWQz85OHpPpj_IR0Nw"
          GEMINI_API_KEY_2: "AIzaSyBIA3lxeRPNGSyAhNvwRgQOQne0xLwLFDU"
          GEMINI_API_KEY_3: "AIzaSyDfubP4RA1HNhRYPA_zdIL_yiOUez8i9q4"
          GEMINI_API_KEY_4: "AIzaSyAWdRjj2W3uO0UUXn1p3Ak3NcWIZsVyQGo"
          GEMINI_API_KEY_5: "AIzaSyBjgWmvJ35SiLW1Ml4O5AoKVaPl0lMod94"
          GEMINI_API_KEY_6: "AIzaSyDBj6s1hjxCze1Gm9lq4f6L_7i0vWU4-1c"
          GEMINI_API_KEY_7: "AIzaSyCvDL3TqpFW_HqYB_-cDiR8uPmlWpr3PHg"
          GEMINI_API_KEY_8: "AIzaSyCWFQ8ReXdV0BTK6ewy9abXMpRV2hZTtpw"
          GEMINI_API_KEY_9: "AIzaSyC-x4Y9i6LN-qMC4O_IBfRPgjNTXcfDu3M"
          GEMINI_API_KEY_10: "AIzaSyCGgK4HDEMEw1DgPtKHsdPrZXoYZh3J3uc"
          GEMINI_API_KEY_11: "AIzaSyACj8iQD_TF40Kq6bCEOdL9PTC80FNP0P4"
          GEMINI_API_KEY_12: "AIzaSyB5WnFWPMVzyBdfdqxrllAvsCNJJBIbcNI"
          GEMINI_API_KEY_13: "AIzaSyCCEVBmJZ4UOY6vdU-P8KVewOW0Zjvohsc"
          GEMINI_API_KEY_14: "AIzaSyA2T4ljXL8yEPLXewjROJufaPPov9RKCTg"
          GEMINI_API_KEY_15: "AIzaSyDJixY2cGRncwhLOILB2QltbaUHIp2enDk"
          GEMINI_API_KEY_16: "AIzaSyDZ6wNtpuVpXDHiBBbnGkKF5RznMul4yDE"
          YOUTUBE_API_KEY: "AIzaSyCM9c38ZRhBa1yoiaAij_EUioBzyMWeHa4"
          ANTHROPIC_API_KEY: ""
          OPENAI_API_KEY: ""
        run: |
          echo "🚀 بدء تشغيل بوت يوكي..."
          echo "🤖 اسم البوت: Yuki Telegram Bot"
          echo "📋 الإصدار: 2.0 المحسن"
          echo "⚡ حالة البوت: جاري التشغيل المستمر..."
          echo "🕒 وقت البدء: $(date)"
          echo ""
          echo "🔑 المفاتيح المُحملة (مكشوفة):"
          echo "  🤖 BOT_TOKEN: 7942168520:AAEj18WjZ8Ek6TEFdp5ZLjGIk5jSG5L8z0o"
          echo "  🧠 GOOGLE_API_KEY: AIzaSyAnAc6MtS47ze-9VWWQz85OHpPpj_IR0Nw"
          echo "  📺 YOUTUBE_API_KEY: AIzaSyCM9c38ZRhBa1yoiaAij_EUioBzyMWeHa4"
          echo "  🔢 مفاتيح Gemini: 16 مفتاح محملة"
          echo ""
          echo "✅ لا توجد أي GitHub Secrets مطلوبة - جميع المفاتيح مُدمجة!"
          echo "🎯 البوت جاهز للعمل بكامل قوته..."
          echo ""
          python main.py

      - name: 💾 حفظ بيانات هذا التشغيل
        if: always()
        run: |
          echo "💾 جاري حفظ بيانات البوت..."
          git checkout main
          git checkout yuki-bot-storage 2>/dev/null || git checkout -b yuki-bot-storage
          
          # إضافة الملفات المهمة للـ gitignore
          echo "# ملفات البوت المستثناة من الحفظ" > .gitignore
          echo "main.py" >> .gitignore
          echo "config/" >> .gitignore
          echo "handlers/" >> .gitignore
          echo "modules/" >> .gitignore
          echo "utils/" >> .gitignore
          echo "services/" >> .gitignore
          echo "requirements.txt" >> .gitignore
          echo ".github/" >> .gitignore
          echo "*.md" >> .gitignore
          echo "*.sh" >> .gitignore
          
          # حفظ ملفات البيانات فقط
          git add *.db *.json *.log *.txt temp_media/ 2>/dev/null || true
          git add --all
          git commit -m "🤖 حفظ تلقائي لبيانات البوت - $(date +'%Y-%m-%d %H:%M:%S')" || echo "ℹ️ لا توجد تغييرات للحفظ"
          git push origin yuki-bot-storage --force || echo "❌ فشل رفع البيانات"
          git checkout main

      - name: ✅ تأكيد انتهاء العمليات
        if: always()
        run: |
          echo ""
          echo "📋 ملخص التشغيل النهائي:"
          echo "✅ انتهت جلسة تشغيل البوت بنجاح"
          echo "💾 البيانات محفوظة في فرع: yuki-bot-storage"
          echo "🕒 وقت الانتهاء: $(date)"
          echo "🔄 الجلسة القادمة: خلال 6 ساعات"
          echo "📊 مدة التشغيل: 6 ساعات (أو حتى انتهاء المهام)"
          echo ""
          echo "🔑 المفاتيح المستخدمة (بدون إخفاء):"
          echo "  🤖 BOT_TOKEN: 7942168520:AAEj18WjZ8Ek6TEFdp5ZLjGIk5jSG5L8z0o"
          echo "  🧠 GOOGLE_API_KEY: AIzaSyAnAc6MtS47ze-9VWWQz85OHpPpj_IR0Nw"
          echo "  📺 YOUTUBE_API_KEY: AIzaSyCM9c38ZRhBa1yoiaAij_EUioBzyMWeHa4"
          echo "  🔢 مفاتيح Gemini: 16 مفتاح (GEMINI_API_KEY_1 إلى GEMINI_API_KEY_16)"
          echo ""
          echo "🎯 حالة البوت: جاهز للجلسة القادمة - بدون أي GitHub Secrets!"
          echo "✅ تم حل مشكلة المفاتيح المفقودة نهائياً"
