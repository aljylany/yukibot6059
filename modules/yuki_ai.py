"""
Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ÙŠÙˆÙƒÙŠ - AI System for Yuki
Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ø¨Ø³ÙŠØ· ÙˆÙ…ØªØ·ÙˆØ± ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
"""

import logging
import asyncio
import json
import random
import re
from typing import Dict, Any, Optional, List
from aiogram.types import Message
from datetime import datetime


class YukiAI:
    """Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ· Ù„Ø¨ÙˆØª ÙŠÙˆÙƒÙŠ"""
    
    def __init__(self):
        self.responses_db = {
            # Ø§Ù„ØªØ­ÙŠØ§Øª
            'greetings': {
                'triggers': ['Ù…Ø±Ø­Ø¨Ø§', 'Ù‡Ù„Ø§', 'Ø§Ù„Ø³Ù„Ø§Ù…', 'Ø£Ù‡Ù„Ø§', 'hi', 'hello', 'Ù…Ø³Ø§Ø¡', 'ØµØ¨Ø§Ø­', 'hey'],
                'responses': [
                    "ğŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹ {user}! Ø£Ù†Ø§ ÙŠÙˆÙƒÙŠØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ",
                    "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ {user}! ÙŠÙˆÙƒÙŠ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ù…Ø¹Ø±ÙØªÙ‡ØŸ",
                    "ğŸ˜Š Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡ {user}! Ø³Ø¹ÙŠØ¯ Ø¨ÙˆØ¬ÙˆØ¯ÙƒØŒ ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
                    "âœ¨ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {user}! Ø£Ù†Ø§ ÙŠÙˆÙƒÙŠ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠØŒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!",
                    "ğŸŒŸ Ø£Ù‡Ù„Ø§Ù‹ {user}! ÙŠÙˆÙƒÙŠ Ù‡Ù†Ø§ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø£Ù† Ø£ÙƒÙˆÙ† Ù…ÙÙŠØ¯Ø§Ù‹ØŸ"
                ]
            },
            
            # Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            'questions': {
                'triggers': ['ÙƒÙŠÙ', 'Ù…Ø§Ø°Ø§', 'Ù…ØªÙ‰', 'Ø£ÙŠÙ†', 'Ù„Ù…Ø§Ø°Ø§', 'Ù…Ù†', 'what', 'how', 'why', 'when', 'where'],
                'responses': [
                    "ğŸ¤” Ø³Ø¤Ø§Ù„ Ù…Ù…ØªØ§Ø² {user}! Ø¯Ø¹Ù†ÙŠ Ø£ÙÙƒØ±... Ù…Ù† Ø®Ø¨Ø±ØªÙŠ ÙƒØ¨ÙˆØª Ø°ÙƒÙŠØŒ Ø£Ù†ØµØ­Ùƒ Ø¨Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙŠØ¶Ø§Ù‹",
                    "ğŸ’¡ {user} Ù‡Ø°Ø§ Ø³Ø¤Ø§Ù„ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! Ø¥Ù„ÙŠÙƒ Ù…Ø§ Ø£Ø¹Ø±ÙÙ‡: Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© Ø´Ø§Ù…Ù„Ø© Ù‡ÙŠ Ø·Ø±Ø­ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø¬ØªÙ…Ø¹",
                    "ğŸ¯ ÙŠØ§ {user}ØŒ Ø³Ø¤Ø§Ù„Ùƒ ÙŠØ³ØªØ­Ù‚ Ø¨Ø­Ø« Ø¯Ù‚ÙŠÙ‚! Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØŒ Ø£Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ Ø£ÙŠØ¶Ø§Ù‹ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø®Ø¨Ø±Ø§Ø¡ Ù‡Ù†Ø§",
                    "ğŸ§  {user} Ø£Ø­Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©! Ù…Ù† ÙˆØ§Ù‚Ø¹ Ø®Ø¨Ø±ØªÙŠØŒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø±ØŒ Ù…Ø§ Ø±Ø£ÙŠÙƒ ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ"
                ]
            },
            
            # Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±
            'thanks': {
                'triggers': ['Ø´ÙƒØ±Ø§', 'Ø´ÙƒØ±Ø§Ù‹', 'ØªØ³Ù„Ù…', 'ÙŠØ¹Ø·ÙŠÙƒ', 'Ù…Ø´ÙƒÙˆØ±', 'thanks', 'thank you'],
                'responses': [
                    "ğŸ˜Š Ø§Ù„Ø¹ÙÙˆ {user}! Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ù‡Ø°Ø§ ÙˆØ§Ø¬Ø¨ÙŠ ÙƒØ¨ÙˆØª Ø°ÙƒÙŠ",
                    "ğŸ’« ØªØ³Ù„Ù…/ÙŠ {user}! Ø³Ø¹ÙŠØ¯ Ø¥Ù†ÙŠ Ù‚Ø¯Ø±Øª Ø£Ø³Ø§Ø¹Ø¯ØŒ Ø£ÙŠ ÙˆÙ‚Øª Ù…Ø­ØªØ§Ø¬/Ø© Ø´ÙŠØ¡",
                    "âœ¨ Ø§Ù„Ù„Ù‡ ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ© {user}! ÙØ±Ø­Ø§Ù† Ø¥Ù†ÙŠ ÙƒÙ†Øª Ù…ÙÙŠØ¯",
                    "ğŸ¤– Ø£ÙŠ ÙˆÙ‚Øª {user}! Ù‡Ø°Ø§ Ø´ØºÙ„ÙŠ Ø§Ù„Ù…ÙØ¶Ù„ - Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ø§Ø³ Ø§Ù„Ø·ÙŠØ¨ÙŠÙ† Ø²ÙŠÙƒ"
                ]
            },
            
            # Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙˆØª
            'bot_games': {
                'triggers': ['Ù„Ø¹Ø¨Ø©', 'Ø§Ù„Ø¹Ø§Ø¨', 'ÙÙ„ÙˆØ³', 'Ø¨Ù†Ùƒ', 'Ø±ØµÙŠØ¯', 'game', 'money', 'bank'],
                'responses': [
                    "ğŸ® {user}! Ø§Ù„Ø¨ÙˆØª Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ø°Ù‡Ù„Ø©! Ø§ÙƒØªØ¨ 'Ø§Ù„Ø£ÙˆØ§Ù…Ø±' Ù„ØªØ±Ù‰ ÙƒÙ„ Ø§Ù„Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª Ø§Ù„Ø±Ù‡ÙŠØ¨Ø©",
                    "ğŸ’° ÙŠØ§ {user}! Ø¹Ù†Ø¯Ù†Ø§ Ù†Ø¸Ø§Ù… Ø§Ù‚ØªØµØ§Ø¯ÙŠ ÙƒØ§Ù…Ù„ ÙˆÙ…ØªØ·ÙˆØ±! Ø¬Ø±Ø¨ 'Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ' Ø£Ùˆ 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„Ø¹Ø§Ø¨'",
                    "ğŸ¦ {user} Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ! Ø§Ù„Ø¨ÙˆØª ÙÙŠÙ‡ Ø¨Ù†ÙˆÙƒ ÙˆØ¹Ù‚Ø§Ø±Ø§Øª ÙˆØ£Ø³Ù‡Ù… ÙƒØ§Ù…Ù„Ø©!",
                    "ğŸ¯ {user} Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨! Ø£Ù„Ø¹Ø§Ø¨Ù†Ø§ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø³ØªØ¨Ù‡Ø±ÙƒØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ù€ 'Ø§Ù„Ø¹Ø§Ø¨' Ø£Ùˆ 'Ø¨Ù†Ùƒ'"
                ]
            },
            
            # Ø§Ù„Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
            'positive': {
                'triggers': ['Ø­Ø¨ÙŠØ¨ÙŠ', 'Ø¹Ø²ÙŠØ²ÙŠ', 'ØµØ¯ÙŠÙ‚', 'ÙŠÙˆÙƒÙŠ', 'Ø­Ù„Ùˆ', 'Ø±Ø§Ø¦Ø¹', 'Ø¬Ù…ÙŠÙ„', 'Ù…Ù…ØªØ§Ø²'],
                'responses': [
                    "ğŸ˜ {user} Ø£Ù†Øª Ø§Ù„Ø£Ø­Ù„Ù‰! Ø³Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ Ø¨ÙˆØ¬ÙˆØ¯Ùƒ Ù…Ø¹Ù†Ø§",
                    "ğŸ’– {user} Ø­Ø¨ÙŠØ¨ Ù‚Ù„Ø¨ÙŠ! Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ù†ÙˆØ±Øª Ø§Ù„Ù…ÙƒØ§Ù†",
                    "ğŸ¥° {user} Ø£Ù†Øª Ø¥Ù†Ø³Ø§Ù† Ø±Ø§Ø¦Ø¹ØŒ Ù…Ø­Ø¸ÙˆØ¸ Ø¥Ù†ÙŠ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ",
                    "âœ¨ {user} Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·ÙŠØ¨ØªÙƒ! Ø£Ù†Øª Ù…Ù† Ø§Ù„Ù†Ø§Ø³ Ø§Ù„Ù„ÙŠ Ø¨ØªØ®Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø£Ø¬Ù…Ù„"
                ]
            },
            
            # Ø§Ù„Ù†ØµØ§Ø¦Ø­ ÙˆØ§Ù„Ø­ÙƒÙ…
            'advice': {
                'triggers': ['Ù†ØµÙŠØ­Ø©', 'Ù…Ø´ÙˆØ±Ø©', 'Ø±Ø£ÙŠÙƒ', 'Ø§Ù‚ØªØ±Ø§Ø­', 'ÙÙƒØ±Ø©', 'advice'],
                'responses': [
                    "ğŸ’¡ {user}ØŒ Ù…Ù† Ø®Ø¨Ø±ØªÙŠ ÙƒØ¨ÙˆØª Ø°ÙƒÙŠ: Ø£ÙØ¶Ù„ Ø§Ø³ØªØ«Ù…Ø§Ø± Ù‡Ùˆ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø·ÙŠØ¨Ø©",
                    "ğŸŒŸ ÙŠØ§ {user}ØŒ Ù†ØµÙŠØ­ØªÙŠ Ù„Ùƒ: ÙƒÙ† ØµØ¨ÙˆØ±Ø§Ù‹ ÙˆØ·ÙŠØ¨Ø§Ù‹ØŒ ÙˆØ§Ù„Ø­ÙŠØ§Ø© Ø³ØªÙƒØ§ÙØ¦Ùƒ",
                    "ğŸ¯ {user} Ø£Ù†ØµØ­Ùƒ Ø¨Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ØŒ ØªØ¹Ù„Ù… Ø´ÙŠØ¡ Ø¬Ø¯ÙŠØ¯ ÙƒÙ„ ÙŠÙˆÙ…ØŒ ÙˆØ³Ø§Ø¹Ø¯ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†",
                    "ğŸ§  Ù…Ù† ÙˆØ§Ù‚Ø¹ ØªØ¬Ø±Ø¨ØªÙŠ {user}: Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø§Ø³ Ø¨Ù„Ø·Ù"
                ]
            },
            
            # Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
            'help': {
                'triggers': ['Ù…Ø³Ø§Ø¹Ø¯Ø©', 'Ø³Ø§Ø¹Ø¯Ù†ÙŠ', 'help', 'Ù…Ø³Ø§Ø¹Ø¯', 'ÙŠÙ„Ø§'],
                'responses': [
                    "ğŸ†˜ {user} Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©! Ù‚Ù„ Ù„ÙŠ Ø¥ÙŠØ´ Ø§Ù„Ù„ÙŠ ØªØ­ØªØ§Ø¬Ù‡ ÙˆØ±Ø§Ø­ Ø£Ø¨Ø°Ù„ Ù‚ØµØ§Ø±Ù‰ Ø¬Ù‡Ø¯ÙŠ",
                    "ğŸ¤ {user} Ø·Ø¨Ø¹Ø§Ù‹ Ø±Ø§Ø­ Ø£Ø³Ø§Ø¹Ø¯Ùƒ! Ù‡Ø°Ø§ Ø´ØºÙ„ÙŠ ÙˆØ­Ø¨ÙŠØŒ Ø¥ÙŠØ´ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŸ",
                    "ğŸ’ª {user} Ù…Ø¹Ùƒ ÙŠÙˆÙƒÙŠ! Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ù„Ù„ÙŠ ØªØ­ØªØ§Ø¬Ù‡ØŒ Ø±Ø§Ø­ Ù†Ø­Ù„Ù‡ Ø³ÙˆØ§",
                    "ğŸ¯ {user} Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ø¬Ø¨ Ø¹Ù„ÙŠÙ‘! ÙˆØ¶Ø­ Ù„ÙŠ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ±Ø§Ø­ Ù†Ø¬Ø¯ Ø­Ù„"
                ]
            }
        }
        
        # Ø±Ø¯ÙˆØ¯ Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…Ø©
        self.fallback_responses = [
            "ğŸ¤” {user}ØŒ Ù…Ø§ ÙÙ‡Ù…Øª ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ø¨Ø³ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª Ø£ÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø©!",
            "ğŸ˜Š ÙŠØ§ {user}ØŒ Ù…Ø´ Ù…ØªØ£ÙƒØ¯ Ø¥ÙŠØ´ ØªÙ‚ØµØ¯ØŒ Ù„ÙƒÙ† ÙŠÙˆÙƒÙŠ Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!",
            "ğŸ’­ {user} ÙƒÙ„Ø§Ù…Ùƒ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! Ø­Ø§ÙˆÙ„ ØªÙˆØ¶Ø­ Ø£ÙƒØ«Ø± Ø£Ùˆ Ø§Ø³Ø£Ù„ Ø¹Ù† Ø´ÙŠØ¡ Ù…Ø­Ø¯Ø¯",
            "ğŸ¤– {user} ÙŠÙˆÙƒÙŠ Ù…Ø­ØªØ§Ø¬ ØªÙˆØ¶ÙŠØ­ Ø£ÙƒØ«Ø±! Ø¥ÙŠØ´ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ ØªØ¹Ø±ÙÙ‡ØŸ"
        ]

    def analyze_message(self, message: str) -> Dict[str, Any]:
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù…Ø´Ø§Ø¹Ø±"""
        message_lower = message.lower()
        
        analysis = {
            'category': 'unknown',
            'confidence': 0,
            'keywords': [],
            'sentiment': 'neutral'  # positive, negative, neutral
        }
        
        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
        max_confidence = 0
        best_category = 'unknown'
        
        for category, data in self.responses_db.items():
            matches = 0
            total_triggers = len(data['triggers'])
            
            for trigger in data['triggers']:
                if trigger in message_lower:
                    matches += 1
                    analysis['keywords'].append(trigger)
            
            if matches > 0:
                confidence = (matches / total_triggers) * 100
                if confidence > max_confidence:
                    max_confidence = confidence
                    best_category = category
        
        analysis['category'] = best_category
        analysis['confidence'] = max_confidence
        
        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø¨Ø³ÙŠØ·
        positive_words = ['Ø­Ø¨ÙŠØ¨ÙŠ', 'Ø±Ø§Ø¦Ø¹', 'Ø¬Ù…ÙŠÙ„', 'Ù…Ù…ØªØ§Ø²', 'Ø´ÙƒØ±Ø§', 'Ø­Ù„Ùˆ', 'Ø¹Ø¸ÙŠÙ…']
        negative_words = ['Ø³ÙŠØ¡', 'Ù…Ø´ Ø­Ù„Ùˆ', 'Ø²Ø¹Ù„Ø§Ù†', 'Ù…ØªØ¶Ø§ÙŠÙ‚', 'Ù…Ø´ÙƒÙ„Ø©']
        
        positive_count = sum(1 for word in positive_words if word in message_lower)
        negative_count = sum(1 for word in negative_words if word in message_lower)
        
        if positive_count > negative_count:
            analysis['sentiment'] = 'positive'
        elif negative_count > positive_count:
            analysis['sentiment'] = 'negative'
        
        return analysis

    def generate_smart_response(self, message: str, user_name: str = "Ø§Ù„ØµØ¯ÙŠÙ‚") -> str:
        """ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ø°ÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"""
        
        analysis = self.analyze_message(message)
        
        # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        if analysis['category'] != 'unknown' and analysis['confidence'] > 20:
            category_responses = self.responses_db[analysis['category']]['responses']
            response = random.choice(category_responses)
        else:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            response = random.choice(self.fallback_responses)
        
        # ØªØ®ØµÙŠØµ Ø§Ù„Ø±Ø¯
        response = response.format(user=user_name)
        
        # Ø¥Ø¶Ø§ÙØ© ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±
        if analysis['sentiment'] == 'positive':
            emojis = ['ğŸ˜Š', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’–']
            response += f" {random.choice(emojis)}"
        
        # Ø¥Ø¶Ø§ÙØ© Ù†ØµØ§Ø¦Ø­ Ø°ÙƒÙŠØ© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹
        if random.random() < 0.3:  # 30% Ø§Ø­ØªÙ…Ø§Ù„
            tips = [
                "\nğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªÙƒØ´Ù Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¨ÙˆØª Ø¨ÙƒØªØ§Ø¨Ø© 'Ø§Ù„Ø¹Ø§Ø¨'!",
                "\nğŸ¯ Ù„Ø§ ØªÙ†Ø³ ØªØ¬Ø±Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø¨Ù€ 'Ø±ØµÙŠØ¯'!",
                "\nâœ¨ Ø§Ù„Ø¨ÙˆØª Ù…Ù„ÙŠØ§Ù† Ù…ÙØ§Ø¬Ø¢ØªØŒ Ø§ÙƒØªØ¨ 'Ø§Ù„Ø£ÙˆØ§Ù…Ø±' Ù„ØªØ´ÙˆÙ!",
                "\nğŸ¤– Ø£Ø­Ø¨ Ø£Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ Ø§Ù„Ø·ÙŠØ¨ÙŠÙ† Ø²ÙŠÙƒ!"
            ]
            if len(response) < 100:  # ÙÙ‚Ø· Ù„Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù‚ØµÙŠØ±Ø©
                response += random.choice(tips)
        
        return response

    def get_time_based_greeting(self, user_name: str) -> str:
        """Ø±Ø¯ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª"""
        hour = datetime.now().hour
        
        if 5 <= hour < 12:
            greetings = [
                f"ğŸŒ… ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± {user_name}! ÙŠÙˆÙƒÙŠ ÙŠØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ø±Ø§Ø¦Ø¹",
                f"â˜€ï¸ ØµØ¨Ø§Ø­ Ø§Ù„Ù†ÙˆØ± {user_name}! Ø¨Ø¯Ø§ÙŠØ© ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ÙŠÙˆÙƒÙŠ",
            ]
        elif 12 <= hour < 17:
            greetings = [
                f"â˜€ï¸ Ø¸Ù‡Ø± Ø³Ø¹ÙŠØ¯ {user_name}! ÙŠÙˆÙƒÙŠ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©",
                f"ğŸŒ Ø£Ù‡Ù„Ø§Ù‹ {user_name}! ÙˆÙ‚Øª Ø±Ø§Ø¦Ø¹ Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„Ù…Ø±Ø­",
            ]
        elif 17 <= hour < 22:
            greetings = [
                f"ğŸŒ… Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± {user_name}! ÙŠÙˆÙƒÙŠ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©",
                f"âœ¨ Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ± {user_name}! ÙˆÙ‚Øª Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹",
            ]
        else:
            greetings = [
                f"ğŸŒ™ Ù„ÙŠÙ„Ø© Ø³Ø¹ÙŠØ¯Ø© {user_name}! ÙŠÙˆÙƒÙŠ Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³Ù‡Ø±",
                f"â­ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ {user_name}! Ø­ØªÙ‰ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ØŒ ÙŠÙˆÙƒÙŠ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©",
            ]
        
        return random.choice(greetings)

# Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
yuki_ai = YukiAI()

async def handle_yuki_ai_message(message: Message):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"""
    try:
        if not message.text or not message.from_user:
            return
        
        user_name = message.from_user.first_name or "Ø§Ù„ØµØ¯ÙŠÙ‚"
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ "ÙŠÙˆÙƒÙŠ"
        text = message.text
        text_lower = text.lower()
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "ÙŠÙˆÙƒÙŠ" ÙÙŠ Ø§Ù„Ù†Øµ
        yuki_triggers = ['ÙŠÙˆÙƒÙŠ', 'yuki', 'ÙŠÙˆÙƒÙ‰']
        
        user_message = ""
        for trigger in yuki_triggers:
            if trigger in text_lower:
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ "ÙŠÙˆÙƒÙŠ"
                try:
                    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
                    start_pos = text_lower.find(trigger)
                    if start_pos != -1:
                        # Ø£Ø®Ø° Ø§Ù„Ù†Øµ Ù…Ù† Ø¨Ø¹Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
                        user_message = text[start_pos + len(trigger):].strip()
                        break
                except:
                    user_message = "Ù…Ø±Ø­Ø¨Ø§"
                break
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙØ§Ø±ØºØ§Ù‹ Ø¨Ø¹Ø¯ ÙŠÙˆÙƒÙŠ Ø£Ùˆ ÙÙ‚Ø· "ÙŠÙˆÙƒÙŠ" Ù„ÙˆØ­Ø¯Ù‡Ø§
        if not user_message or len(user_message.strip()) < 2:
            # Ø±Ø¯ Ø¨ØªØ­ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
            ai_response = yuki_ai.get_time_based_greeting(user_name)
        else:
            # ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ø°ÙƒÙŠ
            ai_response = yuki_ai.generate_smart_response(user_message, user_name)
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
        await message.reply(ai_response)
        
        # Ø¥Ø¶Ø§ÙØ© XP Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        try:
            from modules.enhanced_xp_handler import add_xp_for_activity
            await add_xp_for_activity(message.from_user.id, "ai_interaction")
        except Exception:
            pass
            
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: {e}")
        # Ø±Ø¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
        fallback_responses = [
            "ğŸ¤– Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ Ø¨Ø³ÙŠØ·! Ù„ÙƒÙ† ÙŠÙˆÙƒÙŠ Ù…Ø§ Ø²Ø§Ù„ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ",
            "ğŸ˜… Ø¹ÙÙˆØ§Ù‹ØŒ ØªØ´ÙˆÙŠØ´ ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…! Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¨ÙˆØª",
            "ğŸ”§ Ø¢Ø³ÙØŒ Ø®Ø·Ø£ Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ! Ù„ÙƒÙ† Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨ÙƒØ§Ù…Ù„ Ù‚ÙˆØªÙ‡"
        ]
        await message.reply(f"{random.choice(fallback_responses)}")

async def setup_ollama_model():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªØ«Ø¨ÙŠØª Ø®Ø§Ø±Ø¬ÙŠ"""
    try:
        logging.info("ğŸ¤– Ù†Ø¸Ø§Ù… ÙŠÙˆÙƒÙŠ Ø§Ù„Ø°ÙƒÙŠ Ø¬Ø§Ù‡Ø²!")
        logging.info("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ©")
        logging.info("ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…ÙØ¹Ù‘Ù„")
        logging.info("ğŸ’« Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø¹Ø± ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ Ø¬Ø§Ù‡Ø²")
        return True
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ: {e}")
        return False