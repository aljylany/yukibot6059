"""
ูุธุงู ูุดู ุงูุณุจุงุจ ูุงููุชู ุงูุชููุงุฆู
ูููู ุจูุชู ุงููุณุชุฎุฏููู ุงูุฐูู ูุณุจูู ููุฑุณู ุฑุณุงูุฉ ูู ุงูุณูุฏุฉ ุฑูู
"""

import logging
from aiogram.types import Message, ChatPermissions
from aiogram.exceptions import TelegramBadRequest
# from utils.decorators import ensure_group_only  # ููุนุทู ูุคูุชุงู
from datetime import datetime, timedelta

# ูุงุฆูุฉ ุงููููุงุช ุงููุญุธูุฑุฉ (ุงูุณุจุงุจ)
BANNED_WORDS = [
    # ุณุจุงุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงูุนุงูุฉ
    "ููุจ", "ููุจุฉ", "ุญูุงุฑ", "ุญูุงุฑุฉ", "ุบุจู", "ุบุจูุฉ", "ุฃุญูู", "ุฃุญููุฉ", 
    "ูุณุฎ", "ูุณุฎุฉ", "ูุฐุฑ", "ูุฐุฑุฉ", "ูุนูู", "ูุนููุฉ", "ุฎูุฒูุฑ", "ุฎูุฒูุฑุฉ",
    "ุญููุงู", "ุจูููุฉ", "ุดุฑููุท", "ุดุฑููุทุฉ", "ุนุงูุฑุฉ", "ุนุงูุฑ", "ุฒุงููุฉ", "ุฒุงูู",
    "ูููู", "ููููุฉ", "ููู", "ูุงูู", "ูุณ", "ูุณูุง", "ุฒุจ", "ุฒุจุฑ", "ุทูุฒ",
    "ุงุจู ุงูููุจ", "ุจูุช ุงูููุจ", "ุงุจู ุงูุดุฑููุทุฉ", "ุจูุช ุงูุดุฑููุทุฉ",
    "ูุง ููุจ", "ูุง ููุจุฉ", "ูุง ุญูุงุฑ", "ูุง ุญูุงุฑุฉ", "ูุง ุบุจู", "ูุง ุบุจูุฉ",
    "ุฎุฑุง", "ุฎุฑุงุก", "ูุฑู", "ุชู", "ููุนู", "ุงููุนูุฉ", "ููุญูุณ", "ููุญูุณุฉ",
    "ุญุซุงูุฉ", "ุฒุจุงูุฉ", "ููุงูุฉ", "ุฎุณูุณ", "ุฎุณูุณุฉ", "ุฏููุก", "ุฏููุฆุฉ",
    "ุณุงูุท", "ุณุงูุทุฉ", "ูุงุทู", "ูุงุทูุฉ", "ุฑุฎูุต", "ุฑุฎูุตุฉ",
    
    # ูููุงุช ุฅุถุงููุฉ ูุทููุจุฉ
    "ููููู", "ุงูุฑู", "ุงููู", "ูููู", "ูููููุฉ", "ุงูุฑู", "ุงูุฑูุง",
    "ุงูููู", "ุงููููุง", "ูููููู", "ุงูุฑู", "ูููู", "ูุณูู", "ูุณู",
    "ูุณูุง", "ูุณูู", "ูุณูู", "ูุณูู", "ุฒุจู", "ุฒุจูุง", "ุฒุจูู", "ุฒุจูู",
    
    # ุณุจุงุจ ูููู
    "ูุงููุฏ", "ููุงุฏ", "ุฒููู", "ุฒูููู", "ุซูุฑ", "ุซูุฑู", "ุฌุญุด", "ุฌุญุดู",
    "ุนูุฑูุช", "ุนูุฑูุชู", "ุฏุจู", "ุฏุจูู", "ุฎุฑุจ", "ุฎุฑุจู", "ุตูุนู", "ุตูุน",
    "ูุฑุนู", "ูุฑุน", "ุนุฌุจู", "ุนุฌุจ", "ุญููุฑ", "ุญููุฑู", "ูุบุฏ", "ูุบุฏู",
    "ูููุท", "ูููุทู", "ุญูุฑ", "ุญูุฑู", "ูุฌุณ", "ูุฌุณู", "ูุฑู", "ูุฑูู",
    "ุนูุชูู", "ุนูุชููู", "ุตุนููู", "ุตุนูููู", "ุดุญุงุช", "ุดุญุงุชู", "ูุชุณูู",
    "ูุชุณููู", "ุฐุจุงุญ", "ุฐุจุงุญู", "ุณูุงุญ", "ุณูุงุญู", "ูุฌุฑู", "ูุฌุฑูู",
    "ุญุฑุงูู", "ุญุฑุงููู", "ูุต", "ูุตู", "ูุตุงุจ", "ูุตุงุจู", "ูุญุชุงู", "ูุญุชุงูู",
    "ูุฒูุฑ", "ูุฒูุฑู", "ูุฐุงุจ", "ูุฐุงุจู", "ููุงูู", "ููุงููู", "ุฎุฏุงุน", "ุฎุฏุงุนู",
    "ููุนูู", "ููุนููู", "ุดูุทุงู", "ุดูุทุงูู", "ุงุจููุณ", "ุงุจููุณู",
    
    # ุชุฑููุจุงุช ููููุฉ ุดุงุฆุนุฉ
    "ูุง ูุงููุฏ", "ูุง ููุงุฏ", "ูุง ุฒููู", "ูุง ุฒูููู", "ูุง ุซูุฑ", "ูุง ุซูุฑู",
    "ูุง ุฌุญุด", "ูุง ุฌุญุดู", "ูุง ุนูุฑูุช", "ูุง ุนูุฑูุชู", "ูุง ุฏุจู", "ูุง ุฏุจูู",
    "ุงุจู ุงููุงููุฏ", "ุจูุช ุงูููุงุฏ", "ุงุจู ุงูุฒููู", "ุจูุช ุงูุฒูููู",
    "ููุจ ูููู", "ููุจู ููููู", "ุญูุงุฑ ูููู", "ุญูุงุฑู ููููู",
    
    # ุฅุถุงูุงุช ุดุงุฆุนุฉ
    "ุงุญุง", "ุงุญ", "ุชุจุง", "ูุนูุฉ", "ููุนู ุงุจูู", "ููุนู ุงุจููู", "ุฑูุญ ูุช",
    "ููู ุฎุฑุง", "ุงูู ุฎุฑุง", "ุงูู", "ุงุจูู", "ุงุฎุชู", "ุงุฎูู", "ุงููู",
    "ุนููุชู", "ุนุงุฆูุชู", "ุจูุชู", "ุฏุงุฑู", "ุงุตูู", "ูุตูู", "ูุณูู",
    
    # ูููุงุช ุฌูุณูุฉ ุตุฑูุญุฉ
    "ุฌูุณ", "ุฌูุงุน", "ูุฌุงูุนู", "ููุงุญ", "ููุงูู", "ุณูุณ", "ููุงุฑุณู",
    "ูุนุงุดุฑู", "ููุงุท", "ููุทู", "ููุทูู", "ุดุงุฐ", "ุดุงุฐู", "ูุซูู", "ูุซููู"
]

# ูููุงุช ุฅุถุงููุฉ ุจุตูุบ ูุฎุชููุฉ
BANNED_VARIATIONS = [
    # ุตูุบ ูุฎุชููุฉ ุจุงูุฃุฑูุงู ูุงูุฑููุฒ
    "ูู8", "ู7ุจ", "ุญู4ุฑ", "ุบ8ู", "@ุญูู", "ูุณ5", "ูุฐ7", 
    "ู3ูู", "5ูุฒูุฑ", "ุญ10ุงู", "8ูููุฉ", "ุดุฑู0ุท", "3ุงูุฑุฉ",
    "ูู1ู", "ู1ู", "ู5", "ุฒ8", "ุท1ุฒ", "58ู ุงููู8", "8ูุช ุงููู8ุฉ",
    "ูู10ู", "@ูุฑู", "ุงูู1ู", "ูู10ูู", "@ูุฑู", "ุงู1ูู",
    "ู@ููุฏ", "ู0ุงุฏ", "ุฒ0ูู", "ุซ0ุฑ", "ุฌุญ5", "ุนูุฑ1ุช",
    
    # ุตูุบ ุจุฏููุฉ ูููููุงุช ุงูููููุฉ
    "ูููููุฏ", "ูุงุงุงุงุฏ", "ุฒูููููู", "ุซููููุฑ", "ุฌุญุญุญุด",
    "ุนูุฑููููุช", "ุฏุจุจุจุจู", "ุฎุฑุฑุฑุจ", "ุตูุนุนุนุนู", "ูุฑุนุนุนุนู",
    
    # ุจุฏููุงุช ุจุงูุฅูุฌููุฒูุฉ
    "fuck", "shit", "damn", "bitch", "asshole", "bastard", "whore", "slut",
    "motherfucker", "dickhead", "pussy", "cock", "penis", "vagina",
    
    # ุตูุบ ูุฎุชูุทุฉ
    "ูs", "nูู", "fuck you", "ุงูููู", "kุณ", "zุจ", "tูุฒ",
    "qุงููุฏ", "wุบุฏ", "lููุท", "hููุฑ", "nุฌุณ", "qุฑู"
]

# ุฏูุฌ ุฌููุน ุงููููุงุช ุงููุญุธูุฑุฉ
ALL_BANNED_WORDS = BANNED_WORDS + BANNED_VARIATIONS

def clean_text_for_profanity_check(text: str) -> str:
    """
    ุชูุธูู ุงููุต ูุฅุฒุงูุฉ ุงูุชุดููุฑ ูุงูุชูููู
    """
    if not text:
        return ""
    
    # ุชุญููู ูุฃุญุฑู ุตุบูุฑุฉ
    cleaned = text.lower().strip()
    
    # ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
    cleaned = ' '.join(cleaned.split())
    
    # ุฅุฒุงูุฉ ุงูุฑููุฒ ุงูุดุงุฆุนุฉ ุงููุณุชุฎุฏูุฉ ููุชูููู
    symbols_to_remove = ['*', '_', '-', '+', '=', '|', '\\', '/', '.', ',', '!', '@', '#', '$', '%', '^', '&', '(', ')', '[', ']', '{', '}', '<', '>', '?', '~', '`', '"', "'"]
    for symbol in symbols_to_remove:
        cleaned = cleaned.replace(symbol, '')
    
    # ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุชู ูุฏ ุชููู ุจูู ุงูุญุฑูู
    cleaned = cleaned.replace(' ', '')
    
    # ุชุญููู ุงูุฃุฑูุงู ุงูุดุงุฆุนุฉ ุฅูู ุญุฑูู
    number_replacements = {
        '0': 'o',
        '1': 'i',
        '2': 'z',
        '3': 'e',
        '4': 'a',
        '5': 's',
        '6': 'g',
        '7': 't',
        '8': 'b',
        '9': 'g'
    }
    
    for number, letter in number_replacements.items():
        cleaned = cleaned.replace(number, letter)
    
    # ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช ุงูุฒุงุฆุฏุฉ ููุญุฑูู (ูุซู ูููู -> ูู)
    import re
    cleaned = re.sub(r'(.)\1{2,}', r'\1\1', cleaned)
    
    return cleaned

def generate_text_variations(text: str) -> list:
    """
    ุชูููุฏ ุชูููุนุงุช ูุฎุชููุฉ ูููุต ูููุญุต
    """
    variations = [text]
    
    # ุฅุถุงูุฉ ุงููุต ุงูููุธู
    cleaned = clean_text_for_profanity_check(text)
    if cleaned and cleaned != text:
        variations.append(cleaned)
    
    # ุฅุฒุงูุฉ ุงููุณุงูุงุช ููุท
    no_spaces = text.replace(' ', '')
    if no_spaces != text:
        variations.append(no_spaces)
    
    # ุฅุฒุงูุฉ ุงูุฑููุฒ ุงูุฃุณุงุณูุฉ ููุท
    basic_clean = text
    for symbol in ['*', '_', '-', '.']:
        basic_clean = basic_clean.replace(symbol, '')
    if basic_clean != text:
        variations.append(basic_clean)
    
    return list(set(variations))  # ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช

async def check_for_profanity(message: Message) -> bool:
    """
    ูุญุต ุงูุฑุณุงูุฉ ูููุดู ุนู ุงูุณุจุงุจ ูุน ูุดู ุงูุชุดููุฑ ูุงูุชูููู
    Returns True ุฅุฐุง ููุฌุฏ ุณุจุงุจ
    """
    if not message.text:
        return False
    
    # ุงูุญุตูู ุนูู ุชูููุนุงุช ุงููุต ูููุญุต
    text_variations = generate_text_variations(message.text.lower().strip())
    
    # ูุญุต ูู ุชูููุนุฉ ูุน ูู ูููุฉ ูุญุธูุฑุฉ
    for text_variant in text_variations:
        for banned_word in ALL_BANNED_WORDS:
            if banned_word.lower() in text_variant:
                logging.info(f"ุชู ูุดู ุณุจุงุจ: '{banned_word}' ูู ุงููุต ุงูููุธู: '{text_variant}' (ุงููุต ุงูุฃุตูู: '{message.text[:50]}...')")
                return True
    
    # ูุญุต ุฅุถุงูู ูููููุงุช ุงูููุณูุฉ ุจูุณุงูุงุช ุฃู ุฑููุฒ
    original_text = message.text.lower()
    for banned_word in ALL_BANNED_WORDS:
        # ุชุญููู ุงููููุฉ ุงููุญุธูุฑุฉ ุฅูู ููุท regex ููุจุญุซ ูุน ุฑููุฒ ุงูุชูููู
        import re
        word_pattern = ""
        for char in banned_word.lower():
            word_pattern += char + r"[\*\_\-\.\s\+\=\|\\\/\,\!\@\#\$\%\^\&\(\)\[\]\{\}\<\>\?\~\`\"\'0-9]*"
        
        # ุงูุจุญุซ ุนู ุงูููุท ูู ุงููุต ุงูุฃุตูู
        if re.search(word_pattern, original_text):
            logging.info(f"ุชู ูุดู ุณุจุงุจ ููุดูุฑ: '{banned_word}' ูู ุงููุต: '{message.text[:50]}...'")
            return True
    
    return False

async def mute_user_for_profanity(message: Message) -> bool:
    """
    ูุชู ุงููุณุชุฎุฏู ุจุณุจุจ ุงูุณุจุงุจ
    Returns True ุฅุฐุง ุชู ุงููุชู ุจูุฌุงุญ
    """
    try:
        # ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุจูุช
        bot_member = await message.bot.get_chat_member(message.chat.id, message.bot.id)
        if bot_member.status not in ['administrator', 'creator']:
            logging.warning("ุงูุจูุช ููุณ ูุดุฑู - ูุง ูููู ูุชู ุงููุณุชุฎุฏููู")
            return False
        
        if not hasattr(bot_member, 'can_restrict_members') or not bot_member.can_restrict_members:
            logging.warning("ุงูุจูุช ูุง ูููู ุตูุงุญูุฉ ูุชู ุงููุณุชุฎุฏููู")
            return False
        
        # ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููุณ ูุงูู ุงููุฌููุนุฉ (ุงููุงูู ูุง ูููุชู ุฃุจุฏุงู)
        user_member = await message.bot.get_chat_member(message.chat.id, message.from_user.id)
        if user_member.status == 'creator':
            logging.info("ุงููุณุชุฎุฏู ูุงูู ุงููุฌููุนุฉ - ูู ูุชู ูุชูู")
            return False
        
        # ุงููุดุฑููู ุฃูุถุงู ูุฎุถุนูู ูููุงููู - ูุง ุงุณุชุซูุงุกุงุช
        if user_member.status == 'administrator':
            logging.info("ุงููุณุชุฎุฏู ูุดุฑู ูููู ุณูุชู ูุชูู ุจุณุจุจ ุงูุณุจุงุจ")
        
        # ูุชู ุงููุณุชุฎุฏู ููุฏุฉ ุณุงุนุฉ
        mute_until = datetime.now() + timedelta(hours=1)
        
        permissions = ChatPermissions(
            can_send_messages=False,
            can_send_media_messages=False,
            can_send_polls=False,
            can_send_other_messages=False,
            can_add_web_page_previews=False,
            can_change_info=False,
            can_invite_users=False,
            can_pin_messages=False
        )
        
        await message.bot.restrict_chat_member(
            chat_id=message.chat.id,
            user_id=message.from_user.id,
            permissions=permissions,
            until_date=mute_until
        )
        
        logging.info(f"ุชู ูุชู ุงููุณุชุฎุฏู {message.from_user.id} ููุฏุฉ ุณุงุนุฉ ุจุณุจุจ ุงูุณุจุงุจ")
        return True
        
    except TelegramBadRequest as e:
        logging.error(f"ุฎุทุฃ ูู ูุชู ุงููุณุชุฎุฏู: {e}")
        return False
    except Exception as e:
        logging.error(f"ุฎุทุฃ ุบูุฑ ูุชููุน ูู ูุชู ุงููุณุชุฎุฏู: {e}")
        return False

async def handle_profanity_detection(message: Message) -> bool:
    """
    ูุนุงูุฌ ูุดู ุงูุณุจุงุจ ุงูุฑุฆูุณู
    Returns True ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ุณุจุงุจ ูุชูุช ูุนุงูุฌุชู
    """
    try:
        # ุงูุชุฃูุฏ ูู ุฃู ุงูุฑุณุงูุฉ ูู ูุฌููุนุฉ ูููุณ ุฎุงุต
        if message.chat.type == 'private':
            return False
        
        # ุงุณุชุซูุงุก ุฃูุงูุฑ ุงููุณุญ ูู ูุญุต ุงูุณุจุงุจ
        if message.text:
            text = message.text.strip()
            if text.startswith('ูุณุญ ') or text == 'ูุณุญ ุจุงูุฑุฏ' or text == 'ูุณุญ':
                return False
        
        # ูุญุต ูุฌูุฏ ุณุจุงุจ
        if not await check_for_profanity(message):
            return False
        
        # ูุญุงููุฉ ูุชู ุงููุณุชุฎุฏู ุฃููุงู
        mute_success = await mute_user_for_profanity(message)
        
        # ุญุฐู ุงูุฑุณุงูุฉ ุงููุณูุฆุฉ ุจุนุฏ ุงููุชู
        try:
            await message.delete()
            logging.info("ุชู ุญุฐู ุงูุฑุณุงูุฉ ุงููุณูุฆุฉ")
        except Exception as delete_error:
            logging.warning(f"ูู ูุชููู ูู ุญุฐู ุงูุฑุณุงูุฉ ุงููุณูุฆุฉ: {delete_error}")
        
        # ูุญุต ููุน ุงููุณุชุฎุฏู ููุฑุณุงูุฉ ุงูููุงุณุจุฉ
        user_member = await message.bot.get_chat_member(message.chat.id, message.from_user.id)
        
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุณูุฏุฉ ุฑูู ุญุณุจ ูุฌุงุญ ุงููุชู
        if mute_success:
            # ุชู ุงููุชู ุจูุฌุงุญ (ุนุถู ุนุงุฏู)
            warning_message = await message.answer(
                f"โ๏ธ **ุชู ุฅุณูุงุช {message.from_user.first_name} ููุฑุงู!**\n\n"
                f"๐ **ุงูุณูุฏุฉ ุฑูู ูุง ุชุชุณุงูู ูุน ุงูุณุจ ูุงูููุงู ุงููุฐุฑ**\n"
                f"๐ **ูุฏุฉ ุงููุชู:** ุณุงุนุฉ ูุงููุฉ - ุชุนูู ุงูุฃุฏุจ!\n\n"
                f"โก๏ธ **ุชุญุฐูุฑ ููุฌููุน:** ูู ูุณุจ ูููุชู ุจูุง ุงุณุชุซูุงุกุงุช!\n"
                f"๐ก๏ธ **ููุงููู ุงูุณูุฏุฉ ุฑูู ูุทููุฉ ูุบูุฑ ูุงุจูุฉ ููููุงุด**"
            )
        elif user_member.status == 'administrator':
            # ุงููุณุชุฎุฏู ูุดุฑู - ุฑุณุงูุฉ ุชุญุฐูุฑ ูููุฉ ุฎุงุตุฉ
            warning_message = await message.answer(
                f"๐ฅ **ุฅูุฐุงุฑ ููุงุฆู ูููุดุฑู {message.from_user.first_name}!**\n\n"
                f"๐ **ุงูุณูุฏุฉ ุฑูู ุบุงุถุจุฉ ุฌุฏุงู ูู ุณูููู!**\n"
                f"โ๏ธ **ุญุชู ุงููุดุฑููู ูุฎุถุนูู ูููุงููู ุงูุฃุฏุจ**\n\n"
                f"๐ฃ **ุงูุชุญุฐูุฑ ุงูุฃุฎูุฑ:** ุณููู ุขุฎุฑ ูุณูุชู ุชูุฒูู ุฑุชุจุชู!\n"
                f"๐ก๏ธ **ูุง ุฃุญุฏ ููู ุงููุงููู ูู ููููุฉ ุงูุณูุฏุฉ ุฑูู!**"
            )
        elif user_member.status == 'creator':
            # ูุงูู ุงููุฌููุนุฉ - ุฑุณุงูุฉ ุฏุจูููุงุณูุฉ ููู ูููุฉ
            warning_message = await message.answer(
                f"๐ **ููุงุญุธุฉ ูุญุชุฑูุฉ ููุงูู ุงููุฌููุนุฉ {message.from_user.first_name}**\n\n"
                f"๐ **ุงูุณูุฏุฉ ุฑูู ุชูุฏุฑ ุฏูุฑู ูููู...**\n"
                f"๐ **ุงูุฃุฏุจ ูุทููุจ ูู ุงูุฌููุน ุจูุง ูููู ุฃุตุญุงุจ ุงููุฌููุนุงุช**\n\n"
                f"๐ **ูุฑุฌู ุฃู ุชููู ูุฏูุฉ ููุฃุนุถุงุก ูู ุงูููุงู ุงูููุฐุจ**"
            )
        else:
            # ุนุถู ุนุงุฏู ููู ูุดู ุงููุชู ูุณุจุจ ุขุฎุฑ
            warning_message = await message.answer(
                f"๐ฅ **ุชู ุญุฐู ุฑุณุงูุฉ ูุณูุฆุฉ ูู {message.from_user.first_name}**\n\n"
                f"๐ **ุงูุณูุฏุฉ ุฑูู ุชุญูู ููุง ุจูุฏ ูู ุญุฏูุฏ!**\n"
                f"โ๏ธ **ุงูุชุญุฐูุฑ ุงูุฃุฎูุฑ:** ูู ููุฑุฑ ุงูุณุจ ุณูุชู ุทุฑุฏู!\n\n"
                f"๐ **ูุง ูุฌุงู ููุชุณุงูู ูุน ููุฉ ุงูุฃุฏุจ**"
            )
        
        # ุญุฐู ุฑุณุงูุฉ ุงูุชุญุฐูุฑ ุจุนุฏ 30 ุซุงููุฉ
        try:
            import asyncio
            await asyncio.sleep(30)
            await warning_message.delete()
        except:
            pass  # ูุง ููุดู ุฅุฐุง ูู ูุชููู ูู ุญุฐู ุฑุณุงูุฉ ุงูุชุญุฐูุฑ
        
        return True
        
    except Exception as e:
        logging.error(f"ุฎุทุฃ ูู ูุนุงูุฌ ูุดู ุงูุณุจุงุจ: {e}")
        return False